üß† PROMPT PARA REPLIT AI ‚Äî Integrar Cielo (API 3.0) com checkout transparente + parcelas at√© 10x

Quero migrar o checkout do meu app para a Cielo eCommerce (API 3.0), sem redirecionar (captura de dados do cart√£o no meu front ‚Üí envio ao meu backend ‚Üí backend chama a API da Cielo).
Implemente do zero (ou ajuste o que existir) seguindo exatamente:

1) Requisitos funcionais

Produto: Ingresso (pre√ßo unit√°rio definido por env).

O usu√°rio escolhe quantidade (>=1) e parcelas (1..10) sem juros.

Descri√ß√£o/softDescriptor: 4¬∫ Clube do Grito (cortar/acertar para o limite da Cielo, sem acento; usar env).

OrderId: sequencial do meu sistema, come√ßando a partir de ...000003 (persistido em DB para n√£o repetir).

3DS 2.0: habilitar Authenticate=true no payment (quando suportado) + ReturnUrl para tratar challenge.

Sandbox primeiro, depois produ√ß√£o.

2) Credenciais e env

Criar vari√°veis de ambiente (n√£o hard-code):

CIELO_ENV=sandbox                 # sandbox | prod
CIELO_MERCHANT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
CIELO_MERCHANT_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
INGRESSO_UNIT_PRICE_CENTS=100000  # R$ 1.000,00
CIELO_SOFT_DESCRIPTOR=4CLUBEDOGRITO
PUBLIC_URL=https://meu-dominio.com.br


Headers obrigat√≥rios: MerchantId, MerchantKey, Content-Type: application/json.

Endpoints:

Sandbox: https://apisandbox.cieloecommerce.cielo.com.br/1/sales/

Produ√ß√£o: https://api.cieloecommerce.cielo.com.br/1/sales/

3) Backend (Node/Express)

Criar rotas:

POST /api/pagamentos/cielo/checkout

Body:

{
  qty: number,                  // >=1
  installments: number,         // 1..10 (sem juros)
  card: {
    holder: string,
    number: string,
    expirationMonth: string,    // "12"
    expirationYear: string,     // "2030"
    securityCode: string,       // "123"
    brand?: "Visa"|"Master"|"Amex"|"Elo"|"Hipercard"
  }
}


Regras:

amount = INGRESSO_UNIT_PRICE_CENTS * qty (inteiro, em centavos).

brand pode ser deduzida pelo BIN se n√£o vier.

installments fora de 1..10 ‚Üí 400.

3DS: enviar Authenticate: true e ReturnUrl: ${PUBLIC_URL}/pagamento/cielo/retorno.

Capture: true (captura imediata).

SoftDescriptor: sanitizar (sem acento, m√°x. permitido), usar env.

Request JSON para Cielo (POST /1/sales/):

{
  "MerchantOrderId": "ING-2025-000123",
  "Customer": { "Name": "Convidado" },
  "Payment": {
    "Type": "CreditCard",
    "Amount": 100000,
    "Installments": 3,
    "Capture": true,
    "Authenticate": true,
    "SoftDescriptor": "4CLUBEDOGRITO",
    "ReturnUrl": "https://meu-dominio.com.br/pagamento/cielo/retorno?orderId=ING-2025-000123",
    "CreditCard": {
      "CardNumber": "5448280000000007",
      "Holder": "ELOIZA",
      "ExpirationDate": "12/2036",
      "SecurityCode": "123",
      "Brand": "Master"
    }
  }
}


Resposta ao front:

Em sucesso (2xx): devolver { ok:true, orderId, paymentId, status, tid, authorizationCode } extraindo de response.Payment.

Em erro: repassar status, Code/Message retornados pela Cielo com { ok:false, gateway:"cielo", status, code, message }.

Logs seguros: nunca logar PAN/CVV/keys; logar somente orderId, amount, installments, env.

GET /api/pagamentos/cielo/status/:paymentId

Faz GET no /1/sales/{paymentId} e retorna o status (para pooling no front se necess√°rio).

POST /pagamento/cielo/retorno

ReturnUrl do 3DS: receber callback/redirect, ler orderId e confirmar status consultando paymentId salvo.

(Opcional) POST /api/pagamentos/cielo/cancelar

PUT /1/sales/{paymentId}/void (cancelamento total) ‚Äî s√≥ estrutura.

4) Front-end

Modal ‚ÄúPagar com Cielo‚Äù:

Quantidade (1..N).

Parcelas (sem juros) 1..10; mostrar x de R$ ....

Campos de cart√£o + m√°scara (n√∫mero, validade MM/AAAA, CVV).

fetch("/api/pagamentos/cielo/checkout") com method: POST e headers: application/json.

Tratar respostas:

Se vier ok:true + status de autorizado/capturado, mostrar sucesso.

Se houver 3DS challenge, a Cielo redireciona/retorna via ReturnUrl; exibir ‚Äúconfirmando pagamento...‚Äù e consultar status.

Em erro, exibir message retornada pelo backend.

5) Seguran√ßa/Conformidade

P√°gina do cart√£o servida via HTTPS.

N√£o armazenar PAN/CVV; apenas PaymentId, TID, AuthorizationCode, OrderId, status.

Rate-limit na rota de checkout e valida√ß√µes de payload.

Se j√° temos um cofre/servi√ßo de segredos, reusar; sen√£o, ler MerchantId/Key de env apenas no servidor.

Seguir PCI SAQ A-EP (captura no front, processamento no backend).

6) Testes (sandbox)

Criar script npm run test:cielo:sanity que:

Verifica MerchantId/Key presentes.

Faz uma venda de R$ 1,00 em 1x com cart√£o de teste e mostra status.

Criar endpoint GET /health para ver se o servidor reiniciou.

7) Fallback (opcional)

Manter um bot√£o oculto ‚ÄúPagar via p√°gina hospedada (Checkout Cielo)‚Äù usando o form action=".../buynow" apenas como conting√™ncia. N√£o usar por padr√£o.

Entregue o c√≥digo completo das rotas, helpers de headers Cielo, valida√ß√µes, mapeamento de marcas por BIN, e a tela do front. Se algo j√° existir, refatore para este padr√£o sem quebrar o PIX e o checkout atual.