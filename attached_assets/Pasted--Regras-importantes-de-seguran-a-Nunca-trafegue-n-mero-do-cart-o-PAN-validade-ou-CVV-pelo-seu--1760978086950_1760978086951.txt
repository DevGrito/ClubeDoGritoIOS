‚ö†Ô∏è Regras importantes de seguran√ßa

Nunca trafegue n√∫mero do cart√£o (PAN), validade ou CVV pelo seu backend.

Use o SDK ou Hosted Fields da Cielo no front-end para gerar um CardToken (um c√≥digo substituto do cart√£o).

O backend s√≥ deve receber o token, o valor e as informa√ß√µes do pedido.

Toda comunica√ß√£o com a Cielo deve usar MerchantId e MerchantKey com HTTPS.

Ative o 3DS 2.x, que √© a autentica√ß√£o de seguran√ßa obrigat√≥ria em compras online.

Armazene apenas informa√ß√µes seguras: ID da transa√ß√£o, status, valor, parcelas, bandeira e hora ‚Äî nunca dados de cart√£o.

Configure um webhook (notifica√ß√£o autom√°tica) para receber atualiza√ß√µes da Cielo quando o pagamento for aprovado, recusado ou cancelado.

Separe bem o ambiente de testes (sandbox) e o de produ√ß√£o.

üß≠ Passo a passo de implementa√ß√£o
1. No front-end (aplicativo)

Integre o SDK/Hosted Fields da Cielo.
√â uma biblioteca que cria campos de cart√£o seguros no app, onde o usu√°rio insere o n√∫mero, validade e CVV.
Esses campos s√£o hospedados pela pr√≥pria Cielo, ent√£o os dados nunca passam pelo seu servidor.

Quando o usu√°rio preencher o cart√£o, o SDK retorna um CardToken, que √© um c√≥digo seguro (por exemplo, f5c1d21b-...).

Voc√™ envia para o seu backend apenas:

o CardToken

o valor (amount)

a bandeira (Visa, Master, etc.)

e o identificador do cliente ou do pedido (merchantOrderId).

2. No backend

Configure as credenciais da Cielo (MerchantId e MerchantKey) e o endpoint da Sales API.
No modo de teste, use:

https://apisandbox.cieloecommerce.cielo.com.br


Quando o app enviar o CardToken, seu backend cria a transa√ß√£o chamando:

POST /1/sales/


O corpo da requisi√ß√£o deve ter apenas o token, n√£o o n√∫mero do cart√£o. Exemplo:

{
  "MerchantOrderId": "123",
  "Payment": {
    "Type": "CreditCard",
    "Amount": 5000,
    "Installments": 1,
    "Capture": true,
    "CreditCard": {
      "CardToken": "f5c1d21b-...",
      "Brand": "Visa"
    }
  }
}


A Cielo responder√° com um PaymentId e um Status (1 para autorizado, 2 para pago, 3 para recusado, etc.).

Salve apenas o PaymentId, Status, Valor e Cliente no banco de dados.

3. Configure o webhook (notifica√ß√£o)

A Cielo pode enviar automaticamente uma notifica√ß√£o para o seu servidor quando o status do pagamento mudar.

Configure isso no painel da Cielo (campo ‚ÄúNotification URL‚Äù).

Exemplo de endpoint:

POST /api/webhooks/cielo


O corpo do postback cont√©m o PaymentId e o novo Status.
Assim, voc√™ atualiza o status da compra no seu sistema.

4. Ative o 3DS 2.x

Essa √© a autentica√ß√£o do dono do cart√£o (ex: confirma√ß√£o via app do banco).

Ela evita fraude e √© exigida pelas bandeiras.

No payload de cria√ß√£o do pagamento, adicione:

"Authenticate": true,
"ReturnUrl": "https://clubedogrito.institutoogrito.com.br/pagamento/retorno"


Quando o banco exigir autentica√ß√£o, o usu√°rio faz o desafio (challenge) e, se aprovado, o pagamento √© completado.

5. Garanta idempot√™ncia e seguran√ßa

Gere uma chave √∫nica para cada tentativa de pagamento (merchantOrderId + amount).

Se o usu√°rio clicar duas vezes, a Cielo entender√° que √© a mesma transa√ß√£o.

Use HTTPS, sanitize logs e nunca mostre tokens de pagamento em mensagens de erro.

6. Teste em sandbox

Use cart√µes de teste da Cielo para simular aprova√ß√£o, recusa e 3DS.

Confirme se:

Nenhum dado sens√≠vel aparece nos logs.

O webhook atualiza corretamente o status.

Os status ‚Äúautorizado‚Äù, ‚Äúpago‚Äù e ‚Äúrecusado‚Äù aparecem corretamente no app.

üßæ Em resumo
Etapa	O que fazer	O que n√£o fazer
Front-end	Usar SDK da Cielo e gerar CardToken	Enviar n√∫mero do cart√£o pro backend
Backend	Criar venda com CardToken	Armazenar PAN, CVV, validade
Banco	Guardar apenas ID, valor, status e bandeira	Guardar dados sens√≠veis
Seguran√ßa	Ativar 3DS, HTTPS, idempot√™ncia, webhook	Logar dados confidenciais
Testes	Usar sandbox e simular todas respostas	Testar direto em produ√ß√£o
‚úÖ Resultado final

Pagamento acontece dentro do app, sem redirecionar.

Nenhum dado de cart√£o cru passa pelo backend.

O sistema cumpre LGPD e PCI DSS.

3DS garante seguran√ßa antifraude.

Voc√™ controla o fluxo inteiro via API da Cielo.